{"version":3,"file":"AssetsContractController.js","sourceRoot":"","sources":["../../src/assets/AssetsContractController.ts"],"names":[],"mappings":"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","sourcesContent":["import { BN } from 'ethereumjs-util';\nimport Web3 from 'web3';\nimport abiERC20 from 'human-standard-token-abi';\nimport abiERC721 from 'human-standard-collectible-abi';\nimport abiERC1155 from 'human-standard-multi-collectible-abi';\nimport abiSingleCallBalancesContract from 'single-call-balance-checker-abi';\nimport { BaseController, BaseConfig, BaseState } from '../BaseController';\nimport { ERC721Standard } from './CollectibleStandards/ERC721/ERC721Standard';\nimport { ERC1155Standard } from './CollectibleStandards/ERC1155/ERC1155Standard';\n\nconst SINGLE_CALL_BALANCES_ADDRESS =\n  '0xb1f8e55c7f64d203c1400b9d8555d050f94adf39';\n\n/**\n * @type AssetsContractConfig\n *\n * Assets Contract controller configuration\n * @property provider - Provider used to create a new web3 instance\n */\nexport interface AssetsContractConfig extends BaseConfig {\n  provider: any;\n}\n\n/**\n * @type BalanceMap\n *\n * Key value object containing the balance for each tokenAddress\n * @property [tokenAddress] - Address of the token\n */\nexport interface BalanceMap {\n  [tokenAddress: string]: BN;\n}\n\n/**\n * Controller that interacts with contracts on mainnet through web3\n */\nexport class AssetsContractController extends BaseController<\n  AssetsContractConfig,\n  BaseState\n> {\n  private web3: any;\n\n  private erc721Standard: ERC721Standard = new ERC721Standard();\n\n  private erc1155Standard: ERC1155Standard = new ERC1155Standard();\n\n  /**\n   * Name of this controller used during composition\n   */\n  name = 'AssetsContractController';\n\n  /**\n   * Creates a AssetsContractController instance.\n   *\n   * @param config - Initial options used to configure this controller.\n   * @param state - Initial state to set on this controller.\n   */\n  constructor(\n    config?: Partial<AssetsContractConfig>,\n    state?: Partial<BaseState>,\n  ) {\n    super(config, state);\n    this.defaultConfig = {\n      provider: undefined,\n    };\n    this.initialize();\n  }\n\n  /**\n   * Sets a new provider.\n   *\n   * TODO: Replace this wth a method.\n   *\n   * @property provider - Provider used to create a new underlying Web3 instance\n   */\n  set provider(provider: any) {\n    this.web3 = new Web3(provider);\n  }\n\n  get provider() {\n    throw new Error('Property only used for setting');\n  }\n\n  /**\n   * Get balance or count for current account on specific asset contract.\n   *\n   * @param address - Asset ERC20 contract address.\n   * @param selectedAddress - Current account public address.\n   * @returns Promise resolving to BN object containing balance for current account on specific asset contract.\n   */\n  async getBalanceOf(address: string, selectedAddress: string): Promise<BN> {\n    const contract = new this.web3.eth.Contract(abiERC20, address);\n    return new Promise<BN>((resolve, reject) => {\n      contract.balanceOf(selectedAddress, (error: Error, result: BN) => {\n        /* istanbul ignore if */\n        if (error) {\n          reject(error);\n          return;\n        }\n        resolve(result);\n      });\n    });\n  }\n\n  /**\n   * Query for name for a given ERC20 asset.\n   *\n   * @param address - ERC20 asset contract address.\n   * @returns Promise resolving to the 'decimals'.\n   */\n  async getTokenDecimals(address: string): Promise<string> {\n    const contract = new this.web3.eth.Contract(abiERC20, address);\n    return new Promise<string>((resolve, reject) => {\n      contract.decimals((error: Error, result: string) => {\n        /* istanbul ignore if */\n        if (error) {\n          reject(error);\n          return;\n        }\n        resolve(result);\n      });\n    });\n  }\n\n  /**\n   * Enumerate assets assigned to an owner.\n   *\n   * @param address - ERC721 asset contract address.\n   * @param selectedAddress - Current account public address.\n   * @param index - A collectible counter less than `balanceOf(selectedAddress)`.\n   * @returns Promise resolving to token identifier for the 'index'th asset assigned to 'selectedAddress'.\n   */\n  getCollectibleTokenId(\n    address: string,\n    selectedAddress: string,\n    index: number,\n  ): Promise<string> {\n    const contract = new this.web3.eth.Contract(abiERC721, address);\n    return this.erc721Standard.getCollectibleTokenId(\n      contract,\n      selectedAddress,\n      index,\n    );\n  }\n\n  /**\n   * Query for tokenURI for a given asset.\n   *\n   * @param address - ERC721 asset contract address.\n   * @param tokenId - ERC721 asset identifier.\n   * @returns Promise resolving to the 'tokenURI'.\n   */\n  async getCollectibleTokenURI(\n    address: string,\n    tokenId: string,\n  ): Promise<string> {\n    const contract = new this.web3.eth.Contract(abiERC721, address);\n    return this.erc721Standard.getCollectibleTokenURI(contract, tokenId);\n  }\n\n  /**\n   * Query for name for a given asset.\n   *\n   * @param address - ERC721 or ERC20 asset contract address.\n   * @returns Promise resolving to the 'name'.\n   */\n  async getAssetName(address: string): Promise<string> {\n    const contract = new this.web3.eth.Contract(abiERC721, address);\n    return this.erc721Standard.getAssetName(contract);\n  }\n\n  /**\n   * Query for symbol for a given asset.\n   *\n   * @param address - ERC721 or ERC20 asset contract address.\n   * @returns Promise resolving to the 'symbol'.\n   */\n  async getAssetSymbol(address: string): Promise<string> {\n    const contract = new this.web3.eth.Contract(abiERC721, address);\n    return this.erc721Standard.getAssetSymbol(contract);\n  }\n\n  /**\n   * Query for owner for a given ERC721 asset.\n   *\n   * @param address - ERC721 asset contract address.\n   * @param tokenId - ERC721 asset identifier.\n   * @returns Promise resolving to the owner address.\n   */\n  async getOwnerOf(address: string, tokenId: string): Promise<string> {\n    const contract = new this.web3.eth.Contract(abiERC721, address);\n    return this.erc721Standard.getOwnerOf(contract, tokenId);\n  }\n\n  /**\n   * Query for tokenURI for a given asset.\n   *\n   * @param address - ERC1155 asset contract address.\n   * @param tokenId - ERC1155 asset identifier.\n   * @returns Promise resolving to the 'tokenURI'.\n   */\n  async uriERC1155Collectible(\n    address: string,\n    tokenId: string,\n  ): Promise<string> {\n    const contract = new this.web3.eth.Contract(abiERC1155, address);\n    return this.erc1155Standard.uri(contract, tokenId);\n  }\n\n  /**\n   * Query for balance of a given ERC 1155 token.\n   *\n   * @param userAddress - Wallet public address.\n   * @param collectibleAddress - ERC1155 asset contract address.\n   * @param collectibleId - ERC1155 asset identifier.\n   * @returns Promise resolving to the 'balanceOf'.\n   */\n  async balanceOfERC1155Collectible(\n    userAddress: string,\n    collectibleAddress: string,\n    collectibleId: string,\n  ): Promise<number> {\n    const contract = new this.web3.eth.Contract(abiERC1155, collectibleAddress);\n    return await this.erc1155Standard.getBalanceOf(\n      contract,\n      userAddress,\n      collectibleId,\n    );\n  }\n\n  /**\n   * Transfer single ERC1155 token.\n   *\n   * @param collectibleAddress - ERC1155 token address.\n   * @param senderAddress - ERC1155 token sender.\n   * @param recipientAddress - ERC1155 token recipient.\n   * @param collectibleId - ERC1155 token id.\n   * @param qty - Quantity of tokens to be sent.\n   * @returns Promise resolving to the 'transferSingle' ERC1155 token.\n   */\n  async transferSingleERC1155Collectible(\n    collectibleAddress: string,\n    senderAddress: string,\n    recipientAddress: string,\n    collectibleId: string,\n    qty: string,\n  ): Promise<void> {\n    const contract = new this.web3.eth.Contract(abiERC1155, collectibleAddress);\n    return await this.erc1155Standard.transferSingle(\n      contract,\n      collectibleAddress,\n      senderAddress,\n      recipientAddress,\n      collectibleId,\n      qty,\n    );\n  }\n\n  /**\n   * Get the token balance for a list of token addresses in a single call. Only non-zero balances\n   * are returned.\n   *\n   * @param selectedAddress - The address to check token balances for.\n   * @param tokensToDetect - The token addresses to detect balances for.\n   * @returns The list of non-zero token balances.\n   */\n  async getBalancesInSingleCall(\n    selectedAddress: string,\n    tokensToDetect: string[],\n  ) {\n    const contract = new this.web3.eth.Contract(\n      abiSingleCallBalancesContract,\n      SINGLE_CALL_BALANCES_ADDRESS,\n    );\n    return new Promise<BalanceMap>((resolve, reject) => {\n      contract.balances(\n        [selectedAddress],\n        tokensToDetect,\n        (error: Error, result: BN[]) => {\n          /* istanbul ignore if */\n          if (error) {\n            reject(error);\n            return;\n          }\n          const nonZeroBalances: BalanceMap = {};\n          /* istanbul ignore else */\n          if (result.length > 0) {\n            tokensToDetect.forEach((tokenAddress, index) => {\n              const balance: BN = result[index];\n              /* istanbul ignore else */\n              if (!balance.isZero()) {\n                nonZeroBalances[tokenAddress] = balance;\n              }\n            });\n          }\n          resolve(nonZeroBalances);\n        },\n      );\n    });\n  }\n}\n\nexport default AssetsContractController;\n"]}