{"version":3,"sources":["../src/PersonalMessageManager.ts"],"names":[],"mappings":";;;;;;;;;AACA,SAAS,kBAAkB;AAC3B,SAAS,MAAM,cAAc;AAkEtB,IAAM,yBAAN,cAAqC,uBAI1C;AAAA,EAJK;AAAA;AAQL;AAAA;AAAA;AAAA,SAAS,OAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAYhB,MAAM,qBACJ,eACA,KACiB;AACjB,4BAAwB,aAAa;AACrC,QAAI,KAAK;AACP,oBAAc,SAAS,IAAI;AAAA,IAC7B;AACA,kBAAc,OAAO,qBAAqB,cAAc,IAAI;AAE5D,UAAM,qBAAqB,WAAW,aAAa;AACnD,UAAM,iBAAiB,EAAE,GAAG,eAAe,MAAM,mBAAmB;AAEpE,UAAM,YAAY,OAAO;AACzB,UAAM,cAA+B;AAAA,MACnC,IAAI;AAAA,MACJ,eAAe;AAAA,MACf,uBAAuB,KAAK;AAAA,MAC5B,QAAQ;AAAA,MACR,MAAM,KAAK,IAAI;AAAA,MACf,MAAM;AAAA,IACR;AACA,UAAM,KAAK,WAAW,WAAW;AACjC,SAAK,IAAI,KAAK,qBAAqB;AAAA,MACjC,GAAG;AAAA,MACH,GAAG,EAAE,YAAY,UAAU;AAAA,IAC7B,CAAC;AACD,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,sBACE,eACgC;AAEhC,UAAM,EAAE,YAAY,aAAa,GAAG,uBAAuB,IACzD;AACF,WAAO,QAAQ,QAAQ,sBAAsB;AAAA,EAC/C;AACF;AAEA,IAAO,iCAAQ","sourcesContent":["import type { SIWEMessage } from '@metamask/controller-utils';\nimport { detectSIWE } from '@metamask/controller-utils';\nimport { v1 as random } from 'uuid';\n\nimport type {\n  AbstractMessage,\n  AbstractMessageParams,\n  AbstractMessageParamsMetamask,\n  OriginalRequest,\n} from './AbstractMessageManager';\nimport { AbstractMessageManager } from './AbstractMessageManager';\nimport { normalizeMessageData, validateSignMessageData } from './utils';\n\n/**\n * @type Message\n *\n * Represents and contains data about a 'personal_sign' type signature request.\n * These are created when a signature for a personal_sign call is requested.\n * @property id - An id to track and identify the message object\n * @property messageParams - The parameters to pass to the personal_sign method once the signature request is approved\n * @property type - The json-prc signing method for which a signature request has been made.\n * A 'Message' which always has a 'personal_sign' type\n * @property rawSig - Raw data of the signature request\n */\n// This interface was created before this ESLint rule was added.\n// Convert to a `type` in a future major version.\n// eslint-disable-next-line @typescript-eslint/consistent-type-definitions\nexport interface PersonalMessage extends AbstractMessage {\n  messageParams: PersonalMessageParams;\n}\n\n/**\n * @type PersonalMessageParams\n *\n * Represents the parameters to pass to the personal_sign method once the signature request is approved.\n * @property data - A hex string conversion of the raw buffer data of the signature request\n * @property from - Address to sign this message from\n * @property origin? - Added for request origin identification\n */\n// This interface was created before this ESLint rule was added.\n// Convert to a `type` in a future major version.\n// eslint-disable-next-line @typescript-eslint/consistent-type-definitions\nexport interface PersonalMessageParams extends AbstractMessageParams {\n  data: string;\n  siwe?: SIWEMessage;\n}\n\n/**\n * @type MessageParamsMetamask\n *\n * Represents the parameters to pass to the personal_sign method once the signature request is approved\n * plus data added by MetaMask.\n * @property metamaskId - Added for tracking and identification within MetaMask\n * @property data - A hex string conversion of the raw buffer data of the signature request\n * @property from - Address to sign this message from\n * @property origin? - Added for request origin identification\n */\n// This interface was created before this ESLint rule was added.\n// Convert to a `type` in a future major version.\n// eslint-disable-next-line @typescript-eslint/consistent-type-definitions\nexport interface PersonalMessageParamsMetamask\n  extends AbstractMessageParamsMetamask {\n  data: string;\n}\n\n/**\n * Controller in charge of managing - storing, adding, removing, updating - Messages.\n */\nexport class PersonalMessageManager extends AbstractMessageManager<\n  PersonalMessage,\n  PersonalMessageParams,\n  PersonalMessageParamsMetamask\n> {\n  /**\n   * Name of this controller used during composition\n   */\n  override name = 'PersonalMessageManager' as const;\n\n  /**\n   * Creates a new Message with an 'unapproved' status using the passed messageParams.\n   * this.addMessage is called to add the new Message to this.messages, and to save the\n   * unapproved Messages.\n   *\n   * @param messageParams - The params for the personal_sign call to be made after the message\n   * is approved.\n   * @param req - The original request object possibly containing the origin.\n   * @returns The id of the newly created message.\n   */\n  async addUnapprovedMessage(\n    messageParams: PersonalMessageParams,\n    req?: OriginalRequest,\n  ): Promise<string> {\n    validateSignMessageData(messageParams);\n    if (req) {\n      messageParams.origin = req.origin;\n    }\n    messageParams.data = normalizeMessageData(messageParams.data);\n\n    const ethereumSignInData = detectSIWE(messageParams);\n    const finalMsgParams = { ...messageParams, siwe: ethereumSignInData };\n\n    const messageId = random();\n    const messageData: PersonalMessage = {\n      id: messageId,\n      messageParams: finalMsgParams,\n      securityAlertResponse: req?.securityAlertResponse,\n      status: 'unapproved',\n      time: Date.now(),\n      type: 'personal_sign',\n    };\n    await this.addMessage(messageData);\n    this.hub.emit(`unapprovedMessage`, {\n      ...finalMsgParams,\n      ...{ metamaskId: messageId },\n    });\n    return messageId;\n  }\n\n  /**\n   * Removes the metamaskId property from passed messageParams and returns a promise which\n   * resolves the updated messageParams.\n   *\n   * @param messageParams - The messageParams to modify.\n   * @returns Promise resolving to the messageParams with the metamaskId property removed.\n   */\n  prepMessageForSigning(\n    messageParams: PersonalMessageParamsMetamask,\n  ): Promise<PersonalMessageParams> {\n    // Using delete operation will throw an error on frozen messageParams\n    const { metamaskId: _metamaskId, ...messageParamsWithoutId } =\n      messageParams;\n    return Promise.resolve(messageParamsWithoutId);\n  }\n}\n\nexport default PersonalMessageManager;\n"]}