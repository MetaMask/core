name: Check release

on:
  workflow_call:

jobs:
  check-release:
    name: Check merge queue conflicts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commits for changes in released packages
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin main:origin/main

          mapfile -t PACKAGES < <(find packages -maxdepth 2 -name "package.json" -not -path "*/node_modules/*")
          RELEASED_PACKAGES=()

          # Get all packages being released in this PR
          for package in "${PACKAGES[@]}"; do
            MAIN_VERSION=$(git show "origin/main:$package" | jq -r .version)
            HEAD_VERSION=$(jq -r .version "$package")

            if [ "$HEAD_VERSION" != "$MAIN_VERSION" ]; then
              echo "ðŸ“¦ Package $package is being released (version $MAIN_VERSION -> $HEAD_VERSION)"
              RELEASED_PACKAGES+=("$package")
            fi
          done

          # Get all files changed ahead of this PR.
          git diff --name-only HEAD^..$(git merge-base HEAD origin/main) > changed-files.txt

          CONFLICTS=()
          for pkg in "${RELEASED_PACKAGES[@]}"; do
            pkg_dir=$(dirname "$pkg")
            if grep -q "^$pkg_dir/" changed-files.txt; then
              CONFLICTS+=("$pkg_dir")
            fi
          done

          CONFLICTS=($(printf "%s\n" "${CONFLICTS[@]}" | sort -u))
          if [ ${#CONFLICTS[@]} -ne 0 ]; then
            for conflict in "${CONFLICTS[@]}"; do
              echo "::error:: Release conflict detected in $conflict."
            done
            exit 1
          else
            echo "âœ… No release conflicts detected."
          fi


